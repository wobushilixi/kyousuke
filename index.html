<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æå–œçš„èµ„æºç«™ - æ™ºèƒ½é€šé“è·³è½¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cloud.umami.is/script.js" data-website-id="358a65a0-0a10-4fcd-8f6d-651f44e721e2"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        // è‹¹æœæç®€é£ Tailwind é…ç½®
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007AFF', // è‹¹æœç³»ç»Ÿè“è‰²
                        dark: '#1D1D1F', // æ·±è‰²æ–‡æœ¬
                        light: '#FFFFFF' // çº¯ç™½èƒŒæ™¯
                    },
                    fontFamily: {
                        // æ¨¡æ‹Ÿ SF Pro Display/Textï¼ŒInter æ˜¯ä¸€ä¸ªå¥½çš„æ›¿ä»£å“
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'],
                    },
                },
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
              /* æŸ”å’Œã€åˆ†æ•£çš„è‹¹æœé£é˜´å½± */
              @apply shadow-xl shadow-gray-100/50 hover:shadow-2xl hover:shadow-gray-200/50 transition-all duration-300 border border-transparent hover:border-blue-100/50;
            }
            .btn-style {
              /* æ‰å¹³åŒ–æŒ‰é’®ï¼Œç•¥å¸¦åœ†è§’ï¼Œå‡å°‘åŠ¨æ•ˆå¹…åº¦ */
              @apply transition-all duration-200 active:scale-[0.99] focus:ring-4 focus:ring-primary/50;
            }
        }
    </style>
    <style>
        body {
            scroll-behavior: smooth;
        }
        .countdown-circle {
            stroke-dasharray: 283;
            stroke-dashoffset: 283;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            /* ç§»é™¤è¿‡æ¸¡ï¼Œè®©åœ†ç¯å˜åŒ–æ›´å¹³æ»‘ */
            transition: none; 
        }
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .count-animate {
            /* æ›´è‡ªç„¶çš„è®¡æ•°åŠ¨ç”» */
            transition: opacity 0.3s, transform 0.3s;
        }
        .custom-logo {
            object-fit: cover;
            border-radius: 50%;
            border: 1px solid rgba(0, 122, 255, 0.1); /* æµ…è¾¹æ¡† */
        }
        .visitor-count {
            @apply inline-flex items-center bg-gray-100 text-dark px-3 py-1 rounded-full text-sm font-medium;
        }
    </style>
</head>
<body class="bg-light text-dark min-h-screen">
    <div class="container mx-auto px-4 py-16 md:py-24 max-w-4xl">
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-20 h-20 bg-primary/5 rounded-full mb-6 overflow-hidden">
                <img src="https://img.cdn1.vip/i/6921348cd5a96_1763783820.webp" alt="Logo" class="custom-logo w-full h-full" />
            </div>
            <h1 class="text-3xl md:text-4xl font-bold mb-3 tracking-tight">æå–œçš„èµ„æºç«™</h1>
            <p class="text-gray-500 max-w-md mx-auto mb-4 text-lg">æ™ºèƒ½é€šé“ï¼Œæè‡´é€Ÿåº¦ä½“éªŒ</p>
            <div class="visitor-count">
                <i class="fa fa-users mr-1"></i> å®æ—¶è®¿é—®ï¼š<span id="visitor-count-value">0</span> äºº
            </div>
        </header>

        <section class="bg-white rounded-2xl card-shadow p-6 md:p-8 mb-12">
            <div class="text-center mb-8">
                <h2 class="text-xl font-semibold mb-4 text-dark">æ­£åœ¨è‡ªåŠ¨ä¼˜é€‰æœ€ä½³èŠ‚ç‚¹</h2>
                <div class="flex items-center justify-center">
                    <div class="relative mr-4">
                        <svg class="w-20 h-20" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#E5E7EB" stroke-width="3"/>
                            <circle id="countdown-circle" class="countdown-circle" cx="50" cy="50" r="45" fill="none" stroke="#007AFF" stroke-width="3"/>
                        </svg>
                        <span id="countdown" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 font-extrabold text-2xl text-dark">5</span>
                    </div>
                    <p class="text-gray-500 text-lg">ç§’åè·³è½¬è‡³ <span id="best-channel-name" class="font-bold text-dark">æœ€ä¼˜é€šé“</span></p>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button id="skip-countdown" class="flex-1 bg-primary text-white py-3 px-6 rounded-xl font-semibold btn-style flex items-center justify-center text-lg">
                    <i class="fa fa-arrow-right mr-2"></i> ç«‹å³è·³è½¬
                </button>
                <button id="manual-select" class="flex-1 border border-gray-200 text-dark py-3 px-6 rounded-xl font-semibold btn-style flex items-center justify-center text-lg bg-gray-50 hover:bg-gray-100">
                    <i class="fa fa-list mr-2"></i> æ‰‹åŠ¨é€‰æ‹©é€šé“
                </button>
            </div>
        </section>

        <section id="channels" class="hidden mb-12">
            <h2 class="text-xl font-semibold mb-6 text-center text-dark">é€šé“è¯¦ç»†å»¶è¿Ÿä¸é€‰æ‹©</h2>
            <div class="grid gap-4" id="channels-container">
            </div>
        </section>

        <footer class="text-center text-gray-500 text-sm mt-auto pt-10">
            <div class="mb-4">
                <a href="#" class="hover:text-primary transition-colors">å…³äºæˆ‘ä»¬</a>
                <span class="mx-2 text-gray-300">|</span>
                <a href="mailto:support@example.com" class="hover:text-primary transition-colors">è”ç³»æ”¯æŒ</a>
            </div>
            <p>&copy; 2024 æå–œçš„èµ„æºç«™. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        // èŠ‚ç‚¹é…ç½®
        const channels = [
            { id: 'main', name: 'ä¸»ç«™ç‚¹æ— CDN', url: 'https://xz.kyou.xyz/', tag: 'ä¸»æœåŠ¡å™¨', tagColor: 'bg-green-100 text-green-800', icon: 'fa-server', weight: 100 },
            { id: 'cloudflare', name: 'CloudflareèŠ‚ç‚¹', url: 'https://cloudflare.kyou.xyz/', tag: 'CDNåŠ é€Ÿ', tagColor: 'bg-blue-100 text-blue-800', icon: 'fa-cloud', weight: 50 },
            { id: 'freecdn', name: 'é«˜é˜²cdnèŠ‚ç‚¹', url: 'https://freecdn.kyou.xyz/', tag: 'é«˜é˜²CDN', tagColor: 'bg-blue-100 text-blue-800', icon: 'fa-cloud', weight: 90 },
            { id: 'optimized', name: 'ä¼˜é€‰é«˜é€ŸèŠ‚ç‚¹', url: 'https://cf.kyou.xyz/', tag: 'ä¼˜é€‰', tagColor: 'bg-purple-100 text-purple-800', icon: 'fa-star', weight: 75 }
        ];

        // ğŸš¨ é‡è¦çš„ Worker API åœ°å€ï¼šå·²æ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯å¡«å…¥
        const WORKER_API_URL = 'https://ping-service.sparkling-dust-c2bf.workers.dev/'; 

        // å…¨å±€å˜é‡
        const mainChannel = channels.find(channel => channel.id === 'main');
        let bestChannel = mainChannel;
        const countdownElement = document.getElementById('countdown');
        const countdownCircle = document.getElementById('countdown-circle');
        const skipCountdownBtn = document.getElementById('skip-countdown');
        const manualSelectBtn = document.getElementById('manual-select');
        const channelsSection = document.getElementById('channels');
        const channelsContainer = document.getElementById('channels-container');
        const visitorCountElement = document.getElementById('visitor-count-value');
        const bestChannelNameElement = document.getElementById('best-channel-name');
        let countdown = 5;
        let countdownInterval;
        let visitorCount = 0;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            renderChannels();
            testAllChannels(); // å¯åŠ¨åç«¯æµ‹è¯•
            startCountdown();
            bindEvents();
            simulateVisitorCount();
        });

        // æ¸²æŸ“é€šé“åˆ—è¡¨
        function renderChannels() {
            channelsContainer.innerHTML = channels.map(channel => `
                <div id="channel-${channel.id}" 
                     class="bg-white rounded-2xl p-5 card-shadow cursor-pointer transition-all duration-200"
                     data-url="${channel.url}"
                     onclick="handleChannelSelection('${channel.id}')">
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center">
                            <i class="fa ${channel.icon} text-primary mr-3 text-lg w-6 text-center"></i>
                            <div>
                                <span class="font-semibold text-lg">${channel.name}</span>
                                <span id="channel-tag-${channel.id}" class="text-xs px-2 py-0.5 rounded-full ${channel.tagColor} ml-2">${channel.tag}</span>
                            </div>
                        </div>
                        <div class="flex items-center text-sm text-gray-500">
                            <span class="mr-4 loading-status-${channel.id} text-dark font-medium">
                                <i class="fa fa-spinner loading-spinner mr-1 text-primary"></i> æ£€æµ‹ä¸­...
                            </span>
                            <span class="status-indicator-${channel.id}">
                                <i class="fa fa-circle-o-notch loading-spinner mr-1"></i> è¿æ¥ä¸­...
                            </span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <span class="inline-block w-full bg-primary/10 text-primary text-center py-2 rounded-xl font-medium btn-style text-base">
                            ç‚¹å‡»è®¿é—®
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // ä½¿ç”¨ Cloudflare Worker æµ‹è¯•æ‰€æœ‰é€šé“
        async function testAllChannels() {
            const urls = channels.map(c => c.url);

            try {
                // è°ƒç”¨ Worker API è¿›è¡ŒæœåŠ¡å™¨ç«¯å»¶è¿Ÿæµ‹è¯•
                const response = await fetch(WORKER_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ urls })
                });

                if (!response.ok) {
                    throw new Error('Worker API è¿”å›é”™è¯¯');
                }

                const results = await response.json(); // [{url: '...', latency: 120, isOnline: true}, ...]

                // å¤„ç†å¹¶æ›´æ–°æ¯ä¸ªé€šé“çš„çŠ¶æ€
                for (const result of results) {
                    const channel = channels.find(c => c.url === result.url);
                    if (!channel) continue;

                    channel.latency = result.latency || Infinity;
                    channel.isOnline = result.isOnline;

                    const statusElement = document.querySelector(`.loading-status-${channel.id}`);
                    const indicatorElement = document.querySelector(`.status-indicator-${channel.id}`);

                    if (channel.isOnline && channel.latency < Infinity) {
                        statusElement.innerHTML = `<i class="fa fa-bolt text-green-500 mr-1"></i> ${channel.latency}ms`;
                        indicatorElement.innerHTML = `<i class="fa fa-check-circle text-green-500 mr-1"></i> åœ¨çº¿`;
                    } else {
                        statusElement.innerHTML = `<i class="fa fa-times text-red-500 mr-1"></i> å¤±è´¥`;
                        indicatorElement.innerHTML = `<i class="fa fa-times-circle text-red-500 mr-1"></i> ä¸å¯ç”¨`;
                    }
                }

                // ç­›é€‰å¹¶ç¡®å®šæœ€ä½³é€šé“
                const onlineChannels = channels.filter(c => c.isOnline);
                if (onlineChannels.length > 0) {
                    onlineChannels.sort((a, b) => {
                        // 1. æƒé‡ (é«˜åˆ°ä½)
                        if (b.weight !== a.weight) return b.weight - a.weight;
                        // 2. å»¶è¿Ÿ (ä½åˆ°é«˜)
                        return a.latency - b.latency;
                    });
                    bestChannel = onlineChannels[0];
                } else {
                    bestChannel = mainChannel; // æ‰€æœ‰éƒ½ç¦»çº¿ï¼Œé»˜è®¤å›é€€
                }

            } catch (error) {
                console.error("Worker API è°ƒç”¨å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æˆ–æœ¬åœ°æµ‹é€Ÿ:", error);
                // å¯ä»¥åœ¨è¿™é‡Œå®ç°ä¸€ä¸ªæœ¬åœ° Fallback æµ‹é€Ÿï¼Œä½†å½“å‰ä¿æŒä½¿ç”¨é»˜è®¤ä¸»é€šé“
            }
            
            // æ ‡è®° UI
            updateBestChannelUI();
        }

        function updateBestChannelUI() {
            document.querySelectorAll('[id^="channel-"]').forEach(card => {
                card.classList.remove('border-2', 'border-primary', 'shadow-inner'); // æ¸…é™¤æ—§æ ‡è®°
                document.getElementById(`channel-tag-${card.id.split('-')[1]}`).classList.remove('bg-primary/20', 'text-primary');
            });

            const bestChannelCard = document.getElementById(`channel-${bestChannel.id}`);
            if (bestChannelCard) {
                // æ¨èæ ·å¼ï¼šè¾¹æ¡†å’Œç•¥å¾®ä¸åŒçš„é˜´å½±
                bestChannelCard.classList.add('border-2', 'border-primary', 'shadow-inner'); 
                document.getElementById(`channel-tag-${bestChannel.id}`).classList.add('bg-primary/20', 'text-primary');
            }

            bestChannelNameElement.textContent = `${bestChannel.name} (${bestChannel.latency < Infinity ? bestChannel.latency + 'ms' : 'ä¼˜é€‰'})`;
            skipCountdownBtn.innerHTML = `<i class="fa fa-arrow-right mr-2"></i> ç«‹å³è·³è½¬è‡³ ${bestChannel.latency < Infinity ? bestChannel.latency + 'ms' : 'æœ€ä¼˜'} é€šé“`;
        }


        // å¯åŠ¨å€’è®¡æ—¶
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            
            const totalTime = countdownElement.dataset.original || countdown;
            
            countdownInterval = setInterval(() => {
                countdown--;
                
                // ä½¿ç”¨ CSS è¿‡æ¸¡å®ç°æ•°å­—åŠ¨ç”»
                countdownElement.classList.remove('count-animate');
                void countdownElement.offsetWidth; // å¼ºåˆ¶é‡ç»˜
                countdownElement.classList.add('count-animate');
                
                countdownElement.textContent = countdown;
                
                const currentPercent = ((totalTime - countdown) / totalTime) * 100;
                updateCircle(currentPercent);
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    redirectToChannel(bestChannel);
                }
            }, 1000);
        }

        // æ›´æ–°å€’è®¡æ—¶åœ†ç¯
        function updateCircle(percent) {
            const offset = 283 - (percent / 100) * 283;
            countdownCircle.style.strokeDashoffset = offset;
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            skipCountdownBtn.addEventListener('click', () => {
                if (countdownInterval) clearInterval(countdownInterval);
                redirectToChannel(bestChannel);
            });
            
            manualSelectBtn.addEventListener('click', () => {
                const isHidden = channelsSection.classList.contains('hidden');
                if (isHidden) {
                    channelsSection.classList.remove('hidden');
                    countdownElement.dataset.original = 30; // å»¶é•¿æ‰‹åŠ¨é€‰æ‹©æ—¶é—´
                    smoothSwitchCountdown(countdown, 30);
                    manualSelectBtn.innerHTML = '<i class="fa fa-times mr-2"></i> å…³é—­æ‰‹åŠ¨é€‰æ‹©';
                } else {
                    channelsSection.classList.add('hidden');
                    countdownElement.dataset.original = 5; // æ¢å¤è‡ªåŠ¨è·³è½¬æ—¶é—´
                    smoothSwitchCountdown(countdown, 5);
                    manualSelectBtn.innerHTML = '<i class="fa fa-list mr-2"></i> æ‰‹åŠ¨é€‰æ‹©é€šé“';
                }
            });
        }

        // æ‰‹åŠ¨é€‰æ‹©ç‚¹å‡»å¤„ç†
        function handleChannelSelection(channelId) {
            const selectedChannel = channels.find(c => c.id === channelId);
            if (countdownInterval) clearInterval(countdownInterval);
            redirectToChannel(selectedChannel);
        }

        // è·³è½¬åˆ°æŒ‡å®šé€šé“
        function redirectToChannel(channel) {
            skipCountdownBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> è·³è½¬ä¸­...';
            skipCountdownBtn.disabled = true;
            
            // ç¡®ä¿åœ¨ 300ms åè·³è½¬ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æŒ‰é’®çŠ¶æ€å˜åŒ–
            setTimeout(() => {
                window.location.href = channel.url;
            }, 300);
        }
        
        // å¹³æ»‘åˆ‡æ¢å€’è®¡æ—¶
        function smoothSwitchCountdown(from, to) {
            if (countdownInterval) clearInterval(countdownInterval);
            
            // åŠ¨ç”»æ•ˆæœ
            countdownElement.classList.add('count-animate');
            setTimeout(() => {
                countdown = to;
                countdownElement.textContent = to;
                countdownElement.classList.remove('count-animate');
                updateCircle(0); // åœ†ç¯å½’é›¶
                startCountdown();
            }, 300);
        }

        // æ¨¡æ‹Ÿè®¿é—®è®¡æ•°ï¼ˆçº¯HTMLç‰ˆï¼Œæ— æ³•æŒä¹…åŒ–ï¼‰
        function simulateVisitorCount() {
            // å°è¯•ä»localStorageè·å–ä¸€ä¸ªéšæœºä½†æŒä¹…çš„åŸºç¡€å€¼
            const baseCount = parseInt(localStorage.getItem('baseVisitorCount') || 150 + Math.floor(Math.random() * 50));
            localStorage.setItem('baseVisitorCount', baseCount);
            
            // å½“å‰è®¿é—®äººæ•° = åŸºç¡€äººæ•° + å®æ—¶åœ¨çº¿æ³¢åŠ¨
            visitorCount = baseCount + Math.floor(Math.random() * 10);
            visitorCountElement.textContent = visitorCount;
            
            // æ¨¡æ‹Ÿå®æ—¶æ›´æ–°ï¼ˆæ¯10ç§’æ³¢åŠ¨ä¸€æ¬¡ï¼‰
            setInterval(() => {
                const fluctuation = Math.floor(Math.random() * 5) - 2; // -2 åˆ° +2
                visitorCount += fluctuation;
                if (visitorCount < baseCount) visitorCount = baseCount; // ä¸ä½äºåŸºç¡€å€¼

                // æ•°å­—è¿‡æ¸¡åŠ¨ç”»
                visitorCountElement.classList.add('count-animate');
                setTimeout(() => {
                    visitorCountElement.textContent = visitorCount;
                    visitorCountElement.classList.remove('count-animate');
                }, 500);

            }, 10000);
        }
    </script>
</body>
</html>

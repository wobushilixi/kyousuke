<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>李喜的资源站 - 智能通道跳转</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Umami 统计脚本 -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="358a65a0-0a10-4fcd-8f6d-651f44e721e2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .card-hover {
        @apply transition-all duration-200 hover:shadow-md hover:bg-primary/5;
      }
      .btn-effect {
        @apply transition-all duration-200 hover:shadow-md hover:scale-105 active:scale-95;
      }
      .number-transition {
        @apply transition-all duration-1000 ease-in-out;
      }
    }
  </style>
  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      scroll-behavior: smooth;
    }
    .countdown-circle {
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
      transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .loading-spinner {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes countUp {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }
    .count-animate {
      animation: countUp 0.5s ease-out forwards;
    }
    .custom-logo {
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid rgba(59, 130, 246, 0.2);
    }
    .visitor-count {
      @apply inline-flex items-center bg-primary/10 text-primary px-3 py-1 rounded-full text-sm font-medium;
    }
    .visitor-pulse {
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
  </style>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body class="bg-light text-dark min-h-screen">
  <div class="container mx-auto px-4 py-16 md:py-24 max-w-4xl">
    <header class="text-center mb-10">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-primary/10 rounded-full mb-6 overflow-hidden">
        <img src="https://img.cdn1.vip/i/6921348cd5a96_1763783820.webp" alt="Logo" class="custom-logo w-full h-full" />
      </div>
      <h1 class="text-2xl md:text-3xl font-bold mb-3">李喜的资源站</h1>
      <p class="text-gray-600 max-w-md mx-auto mb-4">自动检测并跳转至最优访问节点</p>
      <!-- 实时访问人数显示 -->
      <div class="visitor-count visitor-pulse">
        <i class="fa fa-users mr-1"></i> 已有 <span id="visitor-count-value">0</span> 人访问
      </div>
    </header>

    <section class="bg-white rounded-xl shadow-sm p-6 md:p-8 mb-12">
      <div class="text-center mb-8">
        <h2 class="text-lg font-semibold mb-4">即将自动跳转</h2>
        <div class="flex items-center justify-center">
          <div class="relative mr-4">
            <svg class="w-16 h-16" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="#E2E8F0" stroke-width="3"/>
              <circle id="countdown-circle" class="countdown-circle" cx="50" cy="50" r="45" fill="none" stroke="#3B82F6" stroke-width="3"/>
            </svg>
            <span id="countdown" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 font-bold text-lg">5</span>
          </div>
          <p class="text-gray-500">秒后跳转至主站点</p>
        </div>
      </div>
      <div class="flex flex-col sm:flex-row gap-4">
        <button id="skip-countdown" class="flex-1 bg-primary text-white py-3 px-6 rounded-lg font-medium btn-effect flex items-center justify-center">
          <i class="fa fa-arrow-right mr-2"></i> 立即跳转
        </button>
        <button id="manual-select" class="flex-1 border border-gray-200 text-dark py-3 px-6 rounded-lg font-medium btn-effect flex items-center justify-center">
          <i class="fa fa-list mr-2"></i> 手动选择
        </button>
      </div>
    </section>

    <section id="channels" class="hidden mb-12">
      <h2 class="text-lg font-semibold mb-6 text-center">选择访问通道</h2>
      <div class="grid gap-4" id="channels-container">
      </div>
    </section>

    <footer class="text-center text-gray-500 text-sm mt-auto">
      <div class="mb-4">
        <a href="#" class="hover:text-primary transition-colors">关于我们</a>
        <span class="mx-2">|</span>
        <a href="mailto:support@example.com" class="hover:text-primary transition-colors">联系支持</a>
      </div>
      <p>&copy; 2024 李喜的资源站. 保留所有权利.</p>
    </footer>
  </div>

  <script>
    // 节点配置
    const channels = [
      {
        id: 'main',
        name: '主站点无CDN',
        url: 'https://xz.kyou.xyz/',
        tag: '推荐',
        tagColor: 'bg-green-100 text-green-800',
        icon: 'fa-server',
        weight: 100
      },
      {
        id: 'cloudflare',
        name: 'Cloudflare节点',
        url: 'https://xz.lidz.netlib.re/',
        tag: 'CDN',
        tagColor: 'bg-blue-100 text-blue-800',
        icon: 'fa-cloud',
        weight: 50
      },
      {
        id: 'optimized',
        name: '优选节点',
        url: 'https://cf.kyou.xyz/',
        tag: '优选',
        tagColor: 'bg-purple-100 text-purple-800',
        icon: 'fa-star',
        weight: 75
      }
    ];

    // 全局变量
    const mainChannel = channels.find(channel => channel.id === 'main');
    let bestChannel = mainChannel;
    const countdownElement = document.getElementById('countdown');
    const countdownCircle = document.getElementById('countdown-circle');
    const skipCountdownBtn = document.getElementById('skip-countdown');
    const manualSelectBtn = document.getElementById('manual-select');
    const channelsSection = document.getElementById('channels');
    const channelsContainer = document.getElementById('channels-container');
    const visitorCountElement = document.getElementById('visitor-count-value');
    let countdown = 5;
    let countdownInterval;
    const PING_COUNT = 3;
    const PING_INTERVAL = 100;
    let visitorCount = 0;

    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      renderChannels();
      testAllChannels();
      startCountdown();
      bindEvents();
      // 模拟访问计数（纯HTML版无法持久化，仅作展示）
      simulateVisitorCount();
    });

    // 渲染通道列表
    function renderChannels() {
      let channelsHTML = '';
      
      channels.forEach(channel => {
        channelsHTML += `
          <div id="channel-${channel.id}" class="bg-white rounded-lg p-5 border border-gray-100 card-hover ${channel.id === 'main' ? 'border-primary' : ''}">
            <div class="flex justify-between items-center mb-3">
              <div class="flex items-center">
                <i class="fa ${channel.icon} text-primary mr-3"></i>
                <span class="font-medium">${channel.name}</span>
              </div>
              <span class="text-xs px-2 py-1 rounded-full ${channel.tagColor}">${channel.tag}</span>
            </div>
            <div class="flex items-center text-sm text-gray-500 mb-4">
              <span class="mr-4 loading-status-${channel.id}">
                <i class="fa fa-spinner loading-spinner mr-1"></i> 检测中...
              </span>
              <span class="status-indicator-${channel.id}">
                <i class="fa fa-circle-o-notch loading-spinner mr-1"></i> 连接中...
              </span>
            </div>
            <a href="${channel.url}" target="_blank" class="block w-full bg-primary/10 text-primary text-center py-2 rounded-lg font-medium btn-effect">
              访问通道
            </a>
          </div>
        `;
      });
      
      channelsContainer.innerHTML = channelsHTML;
    }

    // 测试所有通道
    async function testAllChannels() {
      await pingChannel(mainChannel);
      
      const otherChannels = channels.filter(channel => channel.id !== 'main');
      const testPromises = otherChannels.map(channel => pingChannel(channel));
      await Promise.all(testPromises);
      
      if (mainChannel.isOnline) {
        bestChannel = mainChannel;
      } else {
        const onlineChannels = channels.filter(channel => channel.isOnline);
        if (onlineChannels.length > 0) {
          bestChannel = onlineChannels.sort((a, b) => {
            if (a.weight !== b.weight) {
              return b.weight - a.weight;
            }
            return a.latency - b.latency;
          })[0];
        }
      }
      
      document.querySelectorAll('[id^="channel-"]').forEach(card => {
        card.classList.remove('border-primary');
      });
      const bestChannelCard = document.getElementById(`channel-${bestChannel.id}`);
      if (bestChannelCard) {
        bestChannelCard.classList.add('border-primary');
      }
    }

    // 测试单个通道
    async function pingChannel(channel) {
      const statusElement = document.querySelector(`.loading-status-${channel.id}`);
      const indicatorElement = document.querySelector(`.status-indicator-${channel.id}`);
      const latencies = [];
      let successCount = 0;
      
      try {
        for (let i = 0; i < PING_COUNT; i++) {
          statusElement.innerHTML = `<i class="fa fa-spinner loading-spinner mr-1"></i> 检测中(${i+1}/${PING_COUNT})`;
          
          const startTime = performance.now();
          
          const response = await fetch(channel.url, {
            method: 'HEAD',
            mode: 'cors',
            cache: 'no-cache',
            timeout: 3000
          });
          
          const endTime = performance.now();
          const latency = Math.round(endTime - startTime);
          
          if (response.ok) {
            latencies.push(latency);
            successCount++;
          }
          
          if (i < PING_COUNT - 1) {
            await new Promise(resolve => setTimeout(resolve, PING_INTERVAL));
          }
        }
        
        if (latencies.length > 0) {
          latencies.sort((a, b) => a - b);
          const filteredLatencies = latencies.length > 2 
            ? latencies.slice(1, -1)
            : latencies;
          
          channel.latency = Math.round(filteredLatencies.reduce((sum, val) => sum + val, 0) / filteredLatencies.length);
          channel.isOnline = successCount / PING_COUNT >= 0.5;
        } else {
          channel.latency = Infinity;
          channel.isOnline = false;
        }
        
        if (channel.isOnline) {
          statusElement.innerHTML = `<i class="fa fa-signal text-green-500 mr-1"></i> ${channel.latency}ms`;
          indicatorElement.innerHTML = `<i class="fa fa-check-circle text-green-500 mr-1"></i> 在线`;
        } else {
          statusElement.innerHTML = `<i class="fa fa-signal text-red-500 mr-1"></i> 超时`;
          indicatorElement.innerHTML = `<i class="fa fa-times-circle text-red-500 mr-1"></i> 离线`;
        }
        
      } catch (error) {
        channel.latency = Infinity;
        channel.isOnline = false;
        
        statusElement.innerHTML = `<i class="fa fa-signal text-red-500 mr-1"></i> 失败`;
        indicatorElement.innerHTML = `<i class="fa fa-times-circle text-red-500 mr-1"></i> 不可用`;
      }
    }

    // 启动倒计时
    function startCountdown() {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      
      const totalTime = countdownElement.dataset.original || countdown;
      const elapsedTime = totalTime - countdown;
      const percent = (elapsedTime / totalTime) * 100;
      updateCircle(percent);
      
      countdownInterval = setInterval(() => {
        countdown--;
        
        countdownElement.classList.add('count-animate');
        setTimeout(() => {
          countdownElement.classList.remove('count-animate');
        }, 500);
        
        countdownElement.textContent = countdown;
        
        const currentTotal = countdownElement.dataset.original || (countdown + 1);
        const currentPercent = ((currentTotal - countdown) / currentTotal) * 100;
        updateCircle(currentPercent);
        
        if (countdown <= 0) {
          clearInterval(countdownInterval);
          redirectToBestChannel();
        }
      }, 1000);
    }

    // 更新倒计时圆环
    function updateCircle(percent) {
      const offset = 283 - (percent / 100) * 283;
      countdownCircle.style.strokeDashoffset = offset;
    }

    // 平滑切换倒计时
    function smoothSwitchCountdown(from, to) {
      if (countdownInterval) {
        clearInterval(countdownInterval);
      }
      
      countdownElement.classList.add('count-animate');
      setTimeout(() => {
        countdown = to;
        countdownElement.textContent = to;
        countdownElement.classList.remove('count-animate');
      }, 300);
      
      updateCircle(0);
      
      setTimeout(() => {
        startCountdown();
      }, 500);
    }

    // 绑定事件
    function bindEvents() {
      skipCountdownBtn.addEventListener('click', () => {
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }
        redirectToBestChannel();
      });
      
      manualSelectBtn.addEventListener('click', () => {
        const isHidden = channelsSection.classList.contains('hidden');
        
        if (isHidden) {
          channelsSection.classList.remove('hidden');
          countdownElement.dataset.original = 20;
          smoothSwitchCountdown(5, 20);
        } else {
          channelsSection.classList.add('hidden');
          countdownElement.dataset.original = 5;
          smoothSwitchCountdown(20, 5);
        }
      });
    }

    // 跳转到最优通道
    function redirectToBestChannel() {
      skipCountdownBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 跳转中...';
      skipCountdownBtn.disabled = true;
      
      setTimeout(() => {
        window.location.href = bestChannel.url;
      }, 300);
    }

    // 模拟访问计数（纯HTML版，无法持久化）
    function simulateVisitorCount() {
      // 从localStorage获取计数（仅当前浏览器有效）
      const savedCount = localStorage.getItem('visitorCount') || 0;
      visitorCount = parseInt(savedCount) + 1;
      localStorage.setItem('visitorCount', visitorCount);
      visitorCountElement.textContent = visitorCount;
      
      // 模拟实时更新（每30秒随机增加1-3人）
      setInterval(() => {
        if (Math.random() > 0.7) { // 70%概率增加
          const increment = Math.floor(Math.random() * 3) + 1;
          visitorCount += increment;
          visitorCountElement.textContent = visitorCount;
          visitorCountElement.classList.add('count-animate');
          setTimeout(() => {
            visitorCountElement.classList.remove('count-animate');
          }, 500);
        }
      }, 30000);
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F5F5F7">
    <title>iozz - 智能跳转</title>
    <meta name="description" content="iozz 智能线路检测系统">
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
        }
    </script>

    <style>
        /* --- 核心变量 & Reset (Apple Style) --- */
        :root {
            --ios-blue: #007AFF;
            --ios-gray: #8E8E93;
            --ios-bg: #F5F5F7;
            --card-bg: rgba(255, 255, 255, 0.75);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            --blur: saturate(180%) blur(20px);
            --anim-curve: cubic-bezier(0.25, 1, 0.5, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
            background-color: var(--ios-bg);
            color: #1D1D1F;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            justify-content: center;
        }

        /* --- 布局组件 --- */
        .container {
            width: 100%;
            max-width: 440px;
            padding: 20px;
            z-index: 10;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.8s var(--anim-curve);
        }

        .logo-box {
            width: 88px;
            height: 88px;
            border-radius: 22px; /* iOS App Icon 标准圆角 */
            overflow: hidden;
            margin: 0 auto 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: #fff;
        }
        
        .logo-box img { width: 100%; height: 100%; object-fit: cover; }

        h1 { margin: 0; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; }
        .subtitle { color: var(--ios-gray); font-size: 14px; margin-top: 6px; font-weight: 500; }

        /* --- 卡片 (Glassmorphism) --- */
        .card {
            background: var(--card-bg);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-radius: 24px;
            padding: 32px 24px;
            box-shadow: var(--card-shadow);
            border: 1px solid rgba(255, 255, 255, 0.6);
            text-align: center;
            transition: transform 0.3s var(--anim-curve);
        }

        /* --- 倒计时圆环 --- */
        .timer-wrapper {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
        }
        
        svg.timer-svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .timer-circle-bg { fill: none; stroke: #E5E5EA; stroke-width: 5; }
        .timer-circle-fg { 
            fill: none; 
            stroke: var(--ios-blue); 
            stroke-width: 5; 
            stroke-linecap: round;
            stroke-dasharray: 283;
            stroke-dashoffset: 283; 
            transition: stroke-dashoffset 1s linear;
        }
        
        .timer-num {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 700;
            font-variant-numeric: tabular-nums;
        }

        .status-text { font-size: 15px; color: #86868B; margin-bottom: 24px; }
        .highlight { color: var(--ios-blue); font-weight: 600; }

        /* --- 按钮组 --- */
        .btn-group { display: flex; gap: 12px; margin-top: 10px; }
        
        .btn {
            flex: 1;
            height: 50px;
            border-radius: 14px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn:active { transform: scale(0.96); opacity: 0.8; }

        .btn-primary {
            background: var(--ios-blue);
            color: #fff;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #1D1D1F;
            border: 1px solid rgba(0,0,0,0.05);
        }

        /* --- 列表区域 --- */
        #channel-list {
            margin-top: 24px;
            display: none;
            flex-direction: column;
            gap: 12px;
            animation: slideDown 0.4s var(--anim-curve);
        }

        .list-item {
            background: #fff;
            padding: 16px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.03);
            transition: all 0.2s;
        }
        
        .list-item:active { background: #F2F2F7; }
        .list-item.is-best { border: 1.5px solid var(--ios-blue); background: rgba(0, 122, 255, 0.03); }

        .item-left { display: flex; align-items: center; gap: 12px; }
        .item-icon { 
            width: 36px; height: 36px; 
            background: #F2F2F7; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--ios-blue);
        }
        .item-info h3 { margin: 0; font-size: 15px; font-weight: 600; }
        .item-info p { margin: 2px 0 0; font-size: 12px; color: #8E8E93; }
        
        .latency { font-size: 13px; font-weight: 500; font-family: "SF Mono", monospace; }
        .latency.green { color: #34C759; }
        .latency.yellow { color: #FF9500; }
        .latency.red { color: #FF3B30; }

        /* --- 页脚 & 工具 --- */
        .footer { margin-top: auto; padding: 20px; text-align: center; font-size: 12px; color: #AEAEB2; }
        .footer-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 8px; }
        .icon-link { color: #8E8E93; text-decoration: none; padding: 8px; transition: color 0.2s; }
        .icon-link:hover { color: var(--ios-blue); }

        /* --- 图标 SVG (替代 FontAwesome) --- */
        .icon-svg { width: 18px; height: 18px; fill: currentColor; }

        /* --- 动画 --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="container">
        <header class="header">
            <div class="logo-box">
                <img src="https://img.cdn1.vip/i/6921348cd5a96_1763783820.webp" alt="iozz Logo">
            </div>
            <h1>iozz</h1>
            <p class="subtitle" id="status-line">智能检测 · 极速直达</p>
        </header>

        <div class="card">
            <div class="timer-wrapper">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-circle-bg" cx="50" cy="50" r="45"></circle>
                    <circle id="progress-ring" class="timer-circle-fg" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="timer-num" id="countdown">5</div>
            </div>

            <p class="status-text">
                即将跳转至 <span id="best-node" class="highlight">正在测速...</span>
            </p>

            <div class="btn-group">
                <button id="btn-skip" class="btn btn-primary">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    立即跳转
                </button>
                <button id="btn-manual" class="btn btn-secondary">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                    手动选择
                </button>
            </div>
        </div>

        <div id="channel-list"></div>

        <footer class="footer">
            <div class="footer-links">
                <a href="#" onclick="toggleEmail()" class="icon-link">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                </a>
                <a href="https://qm.qq.com/q/LhZz1nJVGa" target="_blank" class="icon-link">
                    <svg class="icon-svg" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm4.24 16L12 15.45 7.77 18l1.12-4.81-3.73-3.23 4.92-.42L12 5l1.92 4.53 4.92.42-3.73 3.23L16.23 18z"/></svg>
                </a>
            </div>
            <p>&copy; 2024 iozz Network.</p>
        </footer>
    </div>

    <script>
        // --- 配置 ---
        const CONFIG = {
            autoTime: 5,
            manualTime: 20,
            timeout: 2000,
            email: "admin@kyou.xyz",
            nodes: [
                { id: 'hk', name: 'EdgeOne HK', url: 'https://edgeone.qvq.pw/', tag: 'HK', w: 100 },
                { id: 'jp', name: 'Tokyo EO', url: 'https://edge.qvq.pw/', tag: 'JP', w: 90 },
                { id: 'asia', name: 'Asia Direct', url: 'https://file.qvq.pw/', tag: 'CDN', w: 90 }
            ]
        };

        // --- 状态管理 ---
        let state = {
            best: CONFIG.nodes[0],
            time: CONFIG.autoTime,
            timer: null,
            paused: false,
            listVisible: false,
            tested: false
        };

        const el = {
            time: document.getElementById('countdown'),
            ring: document.getElementById('progress-ring'),
            bestName: document.getElementById('best-node'),
            skipBtn: document.getElementById('btn-skip'),
            manualBtn: document.getElementById('btn-manual'),
            list: document.getElementById('channel-list'),
            status: document.getElementById('status-line')
        };

        // --- 核心逻辑 ---
        async function init() {
            renderListSkeleton(); // 先渲染骨架
            startTimer();
            
            // 快速并发测速
            const promises = CONFIG.nodes.map(node => ping(node));
            await Promise.all(promises);
            
            selectBest();
            renderList();
            state.tested = true;
        }

        function ping(node) {
            const start = Date.now();
            const ctrl = new AbortController();
            const timeoutId = setTimeout(() => ctrl.abort(), CONFIG.timeout);

            // 缓存破坏 & 极简 HEAD 请求
            const target = `${node.url}${node.url.includes('?') ? '&' : '?'}t=${Date.now()}`;

            return fetch(target, { method: 'HEAD', mode: 'no-cors', signal: ctrl.signal, cache: 'no-store' })
                .then(() => {
                    node.latency = Date.now() - start;
                    node.online = true;
                })
                .catch(() => {
                    node.latency = 9999;
                    node.online = false;
                })
                .finally(() => clearTimeout(timeoutId));
        }

        function selectBest() {
            const onlineNodes = CONFIG.nodes.filter(n => n.online);
            if (onlineNodes.length > 0) {
                // 简单加权算法：优先权重，其次延迟
                onlineNodes.sort((a, b) => a.latency - b.latency);
                state.best = onlineNodes[0];
                updateUI(state.best);
            } else {
                handleAllOffline();
            }
        }

        function updateUI(node) {
            el.bestName.textContent = node.name;
            el.bestName.style.opacity = 0;
            requestAnimationFrame(() => {
                el.bestName.style.transition = 'opacity 0.5s';
                el.bestName.style.opacity = 1;
            });
            // 预加载
            const link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = node.url;
            document.head.appendChild(link);
        }

        function handleAllOffline() {
            el.bestName.textContent = "所有节点离线";
            el.bestName.style.color = "#FF3B30";
            el.skipBtn.disabled = true;
            el.skipBtn.style.opacity = 0.5;
            stopTimer();
        }

        // --- 倒计时与动画 ---
        function startTimer() {
            if (state.timer) clearInterval(state.timer);
            const totalDash = 283;
            const totalTime = state.listVisible ? CONFIG.manualTime : CONFIG.autoTime;
            state.time = totalTime;

            el.time.textContent = state.time;
            el.ring.style.strokeDashoffset = 0;

            state.timer = setInterval(() => {
                state.time--;
                el.time.textContent = state.time;
                
                // 环形进度计算
                const progress = state.time / totalTime;
                el.ring.style.strokeDashoffset = totalDash * (1 - progress);

                if (state.time <= 0) {
                    clearInterval(state.timer);
                    redirect(state.best);
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(state.timer);
            state.timer = null;
            el.time.textContent = "II"; // Pause icon visual
        }

        function redirect(node) {
            if (!node || !node.url) return;
            el.skipBtn.innerHTML = `<svg class="icon-svg spin" viewBox="0 0 24 24"><path d="M12 4V2C6.48 2 2 6.48 2 12h2c0-4.41 3.59-8 8-8zm0 14c4.41 0 8-3.59 8-8h-2c0 3.31-2.69 6-6 6v2z"/></svg> 跳转中...`;
            // 添加旋转CSS
            const style = document.createElement('style');
            style.innerHTML = `.spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }`;
            document.head.appendChild(style);
            
            setTimeout(() => window.location.href = node.url, 50);
        }

        // --- 交互与列表渲染 ---
        el.skipBtn.addEventListener('click', () => {
            stopTimer();
            redirect(state.best);
        });

        el.manualBtn.addEventListener('click', () => {
            state.listVisible = !state.listVisible;
            if (state.listVisible) {
                el.list.style.display = 'flex';
                el.manualBtn.innerHTML = '收起列表';
                stopTimer(); // 展开时暂停自动跳转，或者重置为更长的时间
                startTimer(); // 使用 manualTime
                renderList();
            } else {
                el.list.style.display = 'none';
                el.manualBtn.innerHTML = `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg> 手动选择`;
                state.time = CONFIG.autoTime; // 重置回短时间
                startTimer();
            }
        });

        function renderListSkeleton() {
            // 简单占位
            el.list.innerHTML = ''; 
        }

        function renderList() {
            el.list.innerHTML = CONFIG.nodes.map(n => {
                const isBest = n.id === state.best.id;
                let latColor = 'green';
                if (n.latency > 200) latColor = 'yellow';
                if (!n.online || n.latency > 800) latColor = 'red';
                const latText = n.online ? `${n.latency}ms` : 'Timeout';

                return `
                <div class="list-item ${isBest ? 'is-best' : ''}" onclick="selectNode('${n.id}')">
                    <div class="item-left">
                        <div class="item-icon">
                            <svg class="icon-svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                        </div>
                        <div class="item-info">
                            <h3>${n.name} ${isBest ? '<span style="font-size:10px;color:#007AFF;background:rgba(0,122,255,0.1);padding:2px 6px;border-radius:4px;">优选</span>' : ''}</h3>
                            <p>${n.tag}</p>
                        </div>
                    </div>
                    <div class="latency ${latColor}">${latText}</div>
                </div>
                `;
            }).join('');
        }

        window.selectNode = (id) => {
            const node = CONFIG.nodes.find(n => n.id === id);
            stopTimer();
            redirect(node);
        }

        window.toggleEmail = () => {
            if(el.status.innerText.includes('@')) {
                el.status.innerText = "智能检测 · 极速直达";
            } else {
                el.status.innerHTML = `<a href="mailto:${CONFIG.email}" style="color:var(--ios-blue);text-decoration:none">${CONFIG.email}</a>`;
            }
        }

        // 启动
        init();

    </script>
</body>
</html>
